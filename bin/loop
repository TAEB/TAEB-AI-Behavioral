#!/usr/bin/env perl
use strict;
use warnings;

use lib 'lib';
use TAEB::Config;
use List::Util 'max';

$| = 1;

while (1) {
    system("perl bin/taeb");
    my $time = time;

    logrotate();

    sleep 2;
    system("clear");
    my $took = time - $time;
    for (reverse 1..(60 - $took)) {
        print $_,"\n";
        sleep 1;
    }
}

sub logrotate {
    my $cfg = TAEB::Config->new->contents->{log_rotation} || {};

    return unless $cfg->{enabled};
    my $max_logs = $cfg->{max_logs} || 10e999;

    mkdir("logs");
    my @logs = map { m#^logs/(?:\w+)\.([0-9]+)\.log\.bz2# ? [$1, $_] : () }
        glob "logs/*";

    my $head = max -1, map { $_->[0] } @logs;  #highest used log index

    unlink map { $_->[1] } grep { $_->[0] <= $head - $max_logs + 1 } @logs;

    for (glob "log/*") {
        s{^log/(.*)\.log}{$1};
        my $dest = sprintf "logs/$_.%05d.log.bz2", $head + 1;
        print "bzipping $dest...";
        system(sprintf "bzip2 < log/$_.log > $dest");
        print "done\n";
    }
}
